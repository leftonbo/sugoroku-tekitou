# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

これはすごろくをテーマにしたインクリメンタル・放置ブラウザゲームです。プレイヤーはサイコロを振って100マスの盤面を進み、クレジットを獲得してアップグレードを購入し、効率化を図ります。

## 開発環境

このプロジェクトは**ブラウザ専用**のゲームで、特別なビルドツールやライブラリのインストールは不要です：

- **開発**: 任意のウェブサーバーまたは直接ファイルを開く
- **実行**: `index.html`をブラウザで開く
- **テスト**: 手動でブラウザ上での動作確認
- **デバッグ**: ブラウザのDevToolsコンソールを使用

## コードアーキテクチャ

### 主要ファイル構成
- `index.html` - メインHTML（Bootstrap 5.3 CDN使用）
- `assets/css/style.css` - カスタムCSS（レスポンシブデザイン、アニメーション）
- `assets/js/` - モジュラー設計によるJavaScriptコード

### モジュラー設計

**関心の分離**により以下のように責務を分散：

#### Core（核となるクラス）
- **`game.js`**: メインゲームクラス、全体の統合・初期化
- **`game-loop.js`**: ゲームループ管理、60fps更新、デバッグ制御

#### Systems（ゲームシステム）
- **`dice-system.js`**: 手動・自動ダイス、タイマー管理
- **`board-system.js`**: 盤面生成、プレイヤー移動、マス目効果
- **`upgrade-system.js`**: アップグレード計算、コスト管理
- **`prestige-system.js`**: 転生、プレステージポイント、統計

#### Data（データ管理）
- **`game-state.js`**: ゲーム状態の定義、デフォルト値、マージ処理
- **`storage-manager.js`**: 自動保存、データ復元、バックアップ機能

#### UI（ユーザーインターフェース）
- **`ui-manager.js`**: DOM操作、イベント処理、部分更新最適化
- **`animation-manager.js`**: アニメーション効果、視覚フィードバック

#### Utils（ユーティリティ）
- **`constants.js`**: 定数、設定値、ゲームバランス調整
- **`math-utils.js`**: 数学関数、確率計算、シード付きランダム

### 重要なゲームシステム

**ダイスシステム（dice-system.js）**:
- **手動ダイス**: 複数個対応、手動実行
- **自動ダイス**: 7種類（2/4/6/8/10/12/20面）、段階的解禁
- **タイマー管理**: 各ダイスの実行間隔制御、負荷システム対応
- **アップグレード**: 速度（間隔短縮）・個数（同時実行数）

**盤面システム（board-system.js）**:
- **動的生成**: レベルごとの盤面再生成、シード付きランダム
- **マス目種類**: 空白、クレジット、進む、戻るマス
- **特殊配置**: 固定戻るマス（レベル10以降、90-99マス目）
- **効果適用**: マス目到達時の効果処理

**アップグレードシステム（upgrade-system.js）**:
- **段階的価格**: 累乗による価格上昇（1.5倍、2倍等）
- **解禁システム**: ダイス種類の段階的解禁
- **コスト計算**: 各アップグレード種類で異なる計算式

**プレステージシステム（prestige-system.js）**:
- **プレステージポイント**: レベル50以降、指数関数的獲得
- **転生処理**: 状態リセット + 統計保存
- **統計管理**: 転生回数、最高記録、総獲得値等の追跡

### データ構造

`gameState`の主要プロパティ：
- **基本状態**: `credits`, `position`, `level`, `rebirthCount`
- **ダイス**: `manualDice`, `autoDice[]` - 各ダイスの状態
- **プレステージ**: `prestigePoints.available/earned`, `prestigeStats`
- **統計**: `stats` - プレイ統計、実績記録
- **タイムスタンプ**: 保存時刻、セッション管理

### UI最適化システム

**部分更新アーキテクチャ（ui-manager.js）**:
- **shouldRegenerateAutoDice()**: 全体再生成の必要性判定
- **updateExistingAutoDice()**: 既存要素の部分更新
- **updateUILight()**: 軽量版更新（ボタン状態のみ）
- **data属性**: ボタン識別・状態管理

**アニメーション管理（animation-manager.js）**:
- **効果別アニメ**: ダイス結果、マス効果、アップグレード成功
- **パフォーマンス配慮**: アニメーション制御、メモリ管理

## 開発方針（最重要）

- **git コミット方針**
  - 指示された作業1単位が終わるごとにコミットする
  - .gitignore に含まれるファイルはコミットしない
  - コミットメッセージの先頭に [gitmoji](https://gitmoji.dev/ja/) を使用すること
    - 頻繁に使用する gitmoji の抜粋
      - 🎉 新規プロジェクト立ち上げ
      - ✨️ 新機能追加
      - 🐛 バグ修正
      - 📝 ドキュメント更新
      - ♻️ リファクタリング
      - 🎨 コードスタイル改善
      - ⚡️ パフォーマンス改善
      - 💥 大幅な仕様変更など破壊的な変更を含む更新
      - 🚀 デプロイ関連
      - 🔧 設定変更
      - 🗃️ 内部データベース更新
      - 💄 UI/UX改善
      - 🚚 ファイル・フォルダ整理
      - 🍱 画像や音声などリソース周りの変更
- **ブランチ作成時の命名規則**
  - `feature/` + 機能名
  - `bugfix/` + バグ内容
  - `refactor/` + リファクタリング内容
  - `docs/` + ドキュメント更新内容
- **日本語でのコメント**
  - すべてのコード内コメントは日本語で記述
- **レスポンシブ対応**
  - Bootstrap + カスタムCSSでモバイル対応済み
- **ゲームバランス**
  - マス目ごとのクレジット獲得量、アップグレード価格、サイコロ解放コストは現在の数値でバランス調整済み
- **デバッグ機能**
  - localhost環境または`?debug=true`パラメータで有効化
  - ゲーム制御：一時停止、1Tick進行、セーブデータ管理
  - 右下デバッグパネルからアクセス可能

## 拡張時の設計指針

### 新機能追加時の考慮点
- **後方互換性**: `gameState`への新プロパティ追加時は`mergeGameState()`で対応
- **UI更新**: 全体更新は避け、部分更新を優先（`updateUILight()`等）
- **アニメーション**: CSS + JavaScriptのクラス操作で実装
- **システム拡張**: 既存Systemクラスの拡張または新規System作成

### パフォーマンス考慮
- **DOM操作最小化**: HTML再生成を避け、既存要素の更新を優先
- **メモリ管理**: イベントリスナーのクリーンアップ、タイマー管理
- **バッチ処理**: 複数の状態変更をまとめて処理

### デバッグ支援
- **コンソールログ**: 重要な処理にはデバッグログを追加
- **エラーハンドリング**: try-catch文で適切なエラー処理
- **開発ツール**: デバッグパネルの機能拡張